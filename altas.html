<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATLAS - Attention & Time Location Allocation System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        /* Import Roboto font */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap');
        
        /* App header styling */
        .app-header {
            width: 100%;
            height: 60px;
            background-color: #ffffff;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            border-radius: 8px;
            font-family: 'Roboto', sans-serif;
            position: relative;
        }
        
        .app-title {
            font-size: 18px;
            font-weight: 700;
            color: #333;
            margin-left: 20px;
            font-family: 'Roboto', sans-serif;
        }
        
        .app-name {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            font-size: 28px;
            font-weight: 800;
            color: #000000;
            font-family: 'Roboto', sans-serif;
        }
        
        .r-symbol {
            font-size: 8px;
            vertical-align: super;
            margin-left: 2px;
            position: relative;
        }
        
        .contact-button {
            position: absolute;
            right: 20px;
            background-color: #f0f0f0;
            color: #666;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 4px 10px;
            font-size: 13px;
            font-family: 'Roboto', sans-serif;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 400;
            transition: all 0.2s ease;
            gap: 5px;
        }
        
        .contact-button:hover {
            background-color: #e6e6e6;
            color: #444;
        }
        
        .contact-icon {
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .page-wrapper {
            display: flex;
            flex-direction: column;
            min-height: calc(100vh - 40px);
        }
        
        .container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            flex: 1;
            margin-bottom: 30px;
        }
        
        /* Footer styling */
        .app-footer {
            text-align: center;
            padding: 15px 0;
            font-family: 'Roboto', sans-serif;
            font-size: 14px;
            color: #666;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            margin-top: auto;
        }
        
        /* Contact modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            max-width: 400px;
            width: 90%;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            margin-top: -10px;
        }
        
        .close:hover {
            color: #000;
        }
        
        .modal h3 {
            margin-top: 0;
            color: #333;
            font-family: 'Roboto', sans-serif;
            font-weight: 500;
        }
        
        .contact-info {
            margin: 15px 0;
        }
        
        .contact-row {
            display: flex;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .contact-type {
            width: 80px;
            font-weight: 500;
            color: #555;
        }
        
        .contact-value {
            color: #0000f3;
        }
        
        h1, h2 {
            text-align: center;
            color: #333;
        }
        h1 {
            margin-bottom: 5px;
            font-size: 2.5em;
            color: #2c3e50;
            letter-spacing: 2px;
        }
        h2 {
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 30px;
            background-color: #fff;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #eee;
        }
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .control-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
            border: 1px solid #ddd;
            position: relative;
            margin-bottom: 10px;
            max-width: 100%;
            box-sizing: border-box;
        }
        .control-item input[type="text"] {
            flex: 1;
            min-width: 0;
            margin-right: 10px;
            padding: 5px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            height: 28px;
        }
        .control-item input[type="number"] {
            width: 50px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-right: 10px;
            height: 28px;
            flex-shrink: 0;
        }
        .remove-btn {
            background-color: #ff4d4d;
            color: white;
            border: none;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            min-width: 24px;
            max-width: 24px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            padding: 0;
        }
        .color-picker {
            width: 24px;
            height: 24px;
            margin-right: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
        }
        .total-display {
            text-align: center;
            font-size: 18px;
            margin: 20px 0;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .total-display.warning {
            background-color: #ffe6e6;
            border-color: #ffb3b3;
            color: #cc0000;
        }
        .total-display.success {
            background-color: #e6ffe6;
            border-color: #b3ffb3;
            color: #006600;
        }
        .button-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        button {
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            min-width: 120px;
        }
        button:hover {
            opacity: 0.9;
        }
        #resetBtn {
            background-color: #f0ad4e;
        }
        #addCategoryBtn {
            background-color: #5bc0de;
        }
        #clearStorageBtn {
            background-color: #f0ad4e;
        }
        .storage-notice {
            text-align: center;
            margin: 15px 0;
            padding: 8px;
            border-radius: 4px;
            font-size: 14px;
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: none;
        }
        .export-group {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            border: 1px solid #ddd;
        }
        .export-group h3 {
            text-align: center;
            margin-top: 0;
            margin-bottom: 15px;
            color: #333;
        }
        .export-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .export-btn {
            background-color: #007bff;
        }
        .export-data-btn {
            background-color: #6610f2;
        }
        .instructions {
            margin-top: 30px;
            padding: 15px;
            background-color: #e8f4fd;
            border-radius: 5px;
            border-left: 4px solid #2196F3;
        }
    </style>
</head>
<body>
    <div class="app-header">
        <div class="app-title">ATLAS</div>
        <div class="app-name">Aladdin<span class="r-symbol">Â®</span></div>
        <button id="contactBtn" class="contact-button">
            <span class="contact-icon">ðŸ“§</span> Contact
        </button>
    </div>
    
    <div class="page-wrapper">
        <div class="container">
            <h1>ATLAS</h1>
            <h2>Attention & Time Location Allocation System</h2>
            <div style="text-align: center; margin-top: -5px; margin-bottom: 20px; display: flex; justify-content: center; align-items: center; flex-wrap: wrap;">
                <span style="color: #555; margin-right: 10px; font-weight: 500;">Working hours:</span>
                <div style="display: flex; align-items: center;">
                    <input type="number" id="startTimeInput" min="1" max="12" value="9" style="width: 50px; text-align: center; padding: 5px; border: 1px solid #ccc; border-radius: 4px;">
                    <span style="margin-left: 5px; color: #666;">am</span>
                </div>
                <span style="color: #666; margin: 0 10px;">to</span>
                <div style="display: flex; align-items: center;">
                    <input type="number" id="endTimeInput" min="1" max="12" value="5" style="width: 50px; text-align: center; padding: 5px; border: 1px solid #ccc; border-radius: 4px;">
                    <span style="margin-left: 5px; color: #666;">pm</span>
                </div>
                <span style="color: #666; margin-left: 10px; margin-right: 10px;">Monday-Friday</span>
                <span style="color: #555; margin: 0 10px; font-weight: 500;">â†’</span>
                <span style="color: #555; margin-right: 10px; font-weight: 500;">Total:</span>
                <input type="number" id="totalHoursInput" min="1" max="168" value="40" style="width: 60px; text-align: center; padding: 5px; border: 1px solid #ccc; border-radius: 4px; font-weight: 500;">
                <span style="color: #666; margin-left: 5px;">hours to allocate</span>
            </div>
            
            <div id="storageNotice" class="storage-notice">
                Your data has been automatically saved to browser storage.
            </div>
            
            <div class="chart-container">
                <canvas id="activityChart"></canvas>
            </div>
            
            <div class="total-display" id="totalDisplay">
                Total: 0 / 40 hours
            </div>
            
            <div class="export-group">
                <h3>Export Options</h3>
                <div class="export-buttons">
                    <button id="exportPngBtn" class="export-btn">Export as PNG</button>
                    <button id="exportJpegBtn" class="export-btn">Export as JPEG</button>
                    <button id="exportCsvBtn" class="export-data-btn">Export Data as CSV</button>
                    <button id="exportJsonBtn" class="export-data-btn">Export Data as JSON</button>
                </div>
            </div>
            
            <div class="controls" id="controls">
                <!-- Controls will be added here dynamically -->
            </div>

            <div class="button-group">
                <button id="addCategoryBtn">Add Category</button>
                <button id="clearStorageBtn">Reset to Default</button>
            </div>
            
            <div class="instructions">
                <h3>Instructions:</h3>
                <p>â€¢ Set your total allocation hours using the input at the top</p>
                <p>â€¢ Click "Add Category" to add new activities</p>
                <p>â€¢ Click the "Ã—" button to remove an activity</p>
                <p>â€¢ Edit activity names and hours as needed</p>
                <p>â€¢ Click the color box to change an activity's color</p>
                <p>â€¢ The total should equal exactly your set total hours (turns green when correct)</p>
                <p>â€¢ Use the export buttons to save your chart as an image or data file</p>
                <p>â€¢ Your data is automatically saved in your browser</p>
                <p>â€¢ Click "Clear Saved Data" to remove saved data from your browser</p>
            </div>
        </div>
        
        <div class="app-footer">
            ðŸŽ¨ Designed by PAG, Aladdin Financial Engineering
        </div>
    </div>

    <!-- Contact Modal -->
    <div id="contactModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>Contact Information</h3>
            <div class="contact-info">
                <div class="contact-row">
                    <div class="contact-type">Email:</div>
                    <div class="contact-value">ning.lu@blackrock.com</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        /**
         * ATLAS - Attention & Time Location Allocation System
         * 
         * This application allows users to allocate their time across different activities or categories.
         * Features include:
         * - Setting a total number of hours to allocate (default: 40)
         * - Adding, editing, and removing activity categories
         * - Visualizing the distribution of hours with a bar chart
         * - Persisting data using browser local storage
         * - Exporting the chart as PNG/JPEG or data as CSV/JSON
         * 
         * @author PAG, Aladdin Financial Engineering
         * @version 1.0
         */

        //====================================================================
        // CONFIGURATION AND INITIALIZATION
        //====================================================================
        
        /**
         * Default color palette for activity categories
         * Using a diverse set of colors for visual distinction between categories
         */
        const colorPalette = [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', 
            '#FF9F40', '#C9CBCF', '#8BC34A', '#673AB7', '#795548',
            '#E91E63', '#03A9F4', '#CDDC39', '#009688', '#9C27B0'
        ];

        /**
         * Returns the default set of activity categories
         * 
         * This function returns a fresh copy of the default categories each time it's called,
         * preventing issues with reference modification. Each category contains a name,
         * allocated hours (value), and a display color.
         * 
         * @returns {Array} Array of default category objects
         */
        function getDefaultCategories() {
            return [
                { name: 'Pod1', value: 10, color: colorPalette[0] },
                { name: 'Pod2', value: 8, color: colorPalette[1] },
                { name: 'Pod3', value: 12, color: colorPalette[2] },
                { name: 'Pod4', value: 5, color: colorPalette[3] },
                { name: 'Pod5', value: 3, color: colorPalette[4] }, // Changed from 7 to 3
                { name: 'Pod6', value: 1, color: colorPalette[5] }, // Changed from 3 to 1
                { name: 'Pod7', value: 1, color: colorPalette[6] }  // Changed from 5 to 1
            ];
        }

        /**
         * Local storage keys for persisting application data
         * 
         * STORAGE_KEY_CATEGORIES: Stores the array of category objects
         * STORAGE_KEY_TOTAL_HOURS: Stores the total hours to allocate
         * STORAGE_KEY_START_TIME: Stores the work day start time (hour value)
         * STORAGE_KEY_END_TIME: Stores the work day end time (hour value)
         */
        const STORAGE_KEY_CATEGORIES = 'atlas_categories';
        const STORAGE_KEY_TOTAL_HOURS = 'atlas_total_hours';
        const STORAGE_KEY_START_TIME = 'atlas_start_time';
        const STORAGE_KEY_END_TIME = 'atlas_end_time';

        /**
         * Application state variables
         */
        // Array to hold all activity categories
        let categories = [];
        
        // Reference to the Chart.js chart instance
        let chart = null;
        
        // Total hours to allocate (default 40)
        let totalHours = 40;
        
        /**
         * DOM element references
         * Cached for better performance and code readability
         */
        const controlsContainer = document.getElementById('controls');
        const totalDisplay = document.getElementById('totalDisplay');
        const addCategoryBtn = document.getElementById('addCategoryBtn');
        const clearStorageBtn = document.getElementById('clearStorageBtn');
        const exportPngBtn = document.getElementById('exportPngBtn');
        const exportJpegBtn = document.getElementById('exportJpegBtn');
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        const exportJsonBtn = document.getElementById('exportJsonBtn');
        const totalHoursInput = document.getElementById('totalHoursInput');
        const startTimeInput = document.getElementById('startTimeInput');
        const endTimeInput = document.getElementById('endTimeInput');
        const storageNotice = document.getElementById('storageNotice');
        
        // Initialize totalHours from input element
        totalHours = parseInt(totalHoursInput.value) || 40;
        
        // Canvas context for Chart.js
        const ctx = document.getElementById('activityChart').getContext('2d');

        //====================================================================
        // CHART CREATION AND MANAGEMENT
        //====================================================================
        
        /**
         * Creates a new Chart.js chart or destroys and replaces an existing one
         * 
         * This function configures a bar chart displaying the allocated hours for each category.
         * If a chart already exists, it's destroyed first to prevent memory leaks and DOM issues.
         * 
         * @returns {Object} The created Chart.js chart instance
         */
        function createChart() {
            // Destroy existing chart if it exists to prevent memory leaks
            if (chart) {
                chart.destroy();
            }
            
            // Create and return a new bar chart with current category data
            return new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: categories.map(item => item.name),
                    datasets: [{
                        label: 'Hours Allocated',
                        data: categories.map(item => item.value),
                        backgroundColor: categories.map(item => item.color),
                        borderColor: categories.map(item => item.color),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Hours'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                // Custom tooltip to show hours unit
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.raw} hours`;
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: `ATLAS - ${totalHours} Hour Distribution`,
                            font: {
                                size: 16
                            }
                        }
                    }
                }
            });
        }
        
        /**
         * Updates the chart with current category data
         * 
         * This function updates the existing chart with the latest category names, values, and colors.
         * It also updates the total hours display and provides visual feedback on whether the total 
         * matches the target total hours.
         * 
         * Visual feedback:
         * - Green: Total equals target total
         * - Red: Total exceeds target total
         * - Default: Total is less than target total
         */
        function updateChart() {
            try {
                if (chart) {
                    // Update the datasets with current category data
                    chart.data.labels = categories.map(item => item.name);
                    chart.data.datasets[0].data = categories.map(item => item.value);
                    chart.data.datasets[0].backgroundColor = categories.map(item => item.color);
                    chart.data.datasets[0].borderColor = categories.map(item => item.color);
                    
                    // Apply changes to the chart
                    chart.update();
                } else {
                    console.log("Chart not initialized yet, creating now");
                    chart = createChart();
                }
                
                // Calculate total allocated hours
                const total = categories.reduce((sum, category) => sum + category.value, 0);
                
                // Update total display text
                totalDisplay.textContent = `Total: ${total} / ${totalHours} hours`;
                
                // Apply visual feedback based on total vs target total
                if (total === totalHours) {
                    // Perfect match - success style (green)
                    totalDisplay.className = 'total-display success';
                } else if (total > totalHours) {
                    // Over allocation - warning style (red)
                    totalDisplay.className = 'total-display warning';
                } else {
                    // Under allocation - default style
                    totalDisplay.className = 'total-display';
                }
            } catch (e) {
                console.error("Error updating chart:", e);
            }
        }
        
        /**
         * Updates the chart title to reflect the current total hours
         * 
         * This function is called when the total hours value changes to keep
         * the chart title in sync with the current total.
         */
        function updateChartTitle() {
            if (chart) {
                chart.options.plugins.title.text = `ATLAS - ${totalHours} Hour Distribution`;
                chart.update();
            }
        }

        //====================================================================
        // LOCAL STORAGE MANAGEMENT
        //====================================================================
        
        /**
         * Saves the current application state to local storage
         * 
         * This function persists the categories array, total hours setting,
         * and the work time settings to the browser's localStorage, allowing 
         * the app state to survive page reloads.
         * It also displays a temporary notification to confirm the save operation.
         */
        function saveToLocalStorage() {
            try {
                // Save categories data as JSON string
                localStorage.setItem(STORAGE_KEY_CATEGORIES, JSON.stringify(categories));
                
                // Save total hours as string
                localStorage.setItem(STORAGE_KEY_TOTAL_HOURS, totalHours.toString());
                
                // Save work time settings
                localStorage.setItem(STORAGE_KEY_START_TIME, startTimeInput.value);
                localStorage.setItem(STORAGE_KEY_END_TIME, endTimeInput.value);
                
                // Show temporary save confirmation
                showStorageNotice();
            } catch (error) {
                console.error('Error saving to localStorage:', error);
                // Could add user notification for storage errors here
            }
        }
        
        /**
         * Loads application state from local storage
         * 
         * This function retrieves and parses the saved categories, total hours,
         * and work time settings from localStorage. If no saved data exists or 
         * if there's an error, it falls back to the default values.
         */
        function loadFromLocalStorage() {
            try {
                // Attempt to load and parse saved categories
                const savedCategories = localStorage.getItem(STORAGE_KEY_CATEGORIES);
                if (savedCategories) {
                    categories = JSON.parse(savedCategories);
                } else {
                    // If no saved categories, use defaults
                    categories = getDefaultCategories();
                }
                
                // Attempt to load saved work time settings
                const savedStartTime = localStorage.getItem(STORAGE_KEY_START_TIME);
                const savedEndTime = localStorage.getItem(STORAGE_KEY_END_TIME);
                
                if (savedStartTime && savedEndTime) {
                    // Set the time inputs to saved values
                    startTimeInput.value = savedStartTime;
                    endTimeInput.value = savedEndTime;
                    
                    // Calculate total hours from times (start is always AM, end is always PM)
                    totalHours = calculateTotalHours(
                        parseInt(savedStartTime), 
                        parseInt(savedEndTime)
                    );
                } else {
                    // If no saved times, try loading total hours directly
                    const savedTotalHours = localStorage.getItem(STORAGE_KEY_TOTAL_HOURS);
                    if (savedTotalHours) {
                        totalHours = parseInt(savedTotalHours);
                        
                        // Default to 9am to 5pm
                        startTimeInput.value = 9;
                        endTimeInput.value = 5;
                    } else {
                        // No saved hours either - use defaults
                        totalHours = 40; // Default to 40 hours
                        startTimeInput.value = 9;
                        endTimeInput.value = 5;
                    }
                }
                
                // Validate hour inputs are within range (1-12)
                let startHour = parseInt(startTimeInput.value);
                if (isNaN(startHour) || startHour < 1 || startHour > 12) {
                    startTimeInput.value = 9; // Default to 9 if invalid
                }
                
                let endHour = parseInt(endTimeInput.value);
                if (isNaN(endHour) || endHour < 1 || endHour > 12) {
                    endTimeInput.value = 5; // Default to 5 if invalid
                }
                
                // Update the total hours input
                totalHoursInput.value = totalHours;
                
            } catch (error) {
                console.error('Error loading from localStorage:', error);
                // If there's any error in loading, fall back to defaults
                categories = getDefaultCategories();
                startTimeInput.value = 9;  // 9am
                endTimeInput.value = 5;    // 5pm
                totalHours = 40;
                totalHoursInput.value = totalHours;
            }
        }
        
        /**
         * Clears saved data from local storage and resets to defaults
         * 
         * This function removes all saved application data from localStorage and
         * resets the application state to the default values. It then saves these
         * default values back to localStorage to ensure consistent behavior.
         */
        function clearLocalStorage() {
            try {
                // Remove all saved data
                localStorage.removeItem(STORAGE_KEY_CATEGORIES);
                localStorage.removeItem(STORAGE_KEY_TOTAL_HOURS);
                localStorage.removeItem(STORAGE_KEY_START_TIME);
                localStorage.removeItem(STORAGE_KEY_END_TIME);
                
                // Reset to default values
                categories = getDefaultCategories();
                totalHours = 40;
                totalHoursInput.value = totalHours;
                
                // Reset time inputs to defaults (9am-5pm)
                startTimeInput.value = "9";
                endTimeInput.value = "5";
                
                // Update UI with default values
                renderControls();
                
                // Recreate and update the chart
                if (chart) {
                    chart.destroy();
                }
                chart = createChart();
                updateChart();
                
                // IMPORTANT: Save the default values back to localStorage
                // This ensures a clean state for future app sessions
                localStorage.setItem(STORAGE_KEY_CATEGORIES, JSON.stringify(categories));
                localStorage.setItem(STORAGE_KEY_TOTAL_HOURS, totalHours.toString());
                localStorage.setItem(STORAGE_KEY_START_TIME, startTimeInput.value);
                localStorage.setItem(STORAGE_KEY_END_TIME, endTimeInput.value);
                
                // Show confirmation to user
                storageNotice.textContent = 'Reset to default categories complete.';
                storageNotice.style.display = 'block';
                setTimeout(() => {
                    storageNotice.style.display = 'none';
                }, 3000);
                
                // Additional alert for more visibility
                alert('Reset to default categories complete.');
            } catch (error) {
                console.error('Error clearing localStorage:', error);
                alert('Error resetting data. Please try again.');
            }
        }
        
        /**
         * Displays a temporary storage notification
         * 
         * Shows a notification to inform the user that their data has been saved,
         * then automatically hides the notification after a delay.
         */
        function showStorageNotice() {
            // Display the notification
            storageNotice.style.display = 'block';
            
            // Hide the notification after 3 seconds
            setTimeout(() => {
                storageNotice.style.display = 'none';
            }, 3000);
        }
        
        //====================================================================
        // UI RENDERING AND INTERACTION
        //====================================================================
        
        /**
         * Renders the category control elements in the UI
         * 
         * This function dynamically creates the UI controls for each category,
         * including color pickers, name inputs, hour inputs, and remove buttons.
         * Event listeners are attached to handle user interaction with each control.
         */
        function renderControls() {
            // Clear existing controls to prevent duplicates
            controlsContainer.innerHTML = '';
            
            // Create input controls for each category
            categories.forEach((category, index) => {
                // Create container for this category's controls
                const controlItem = document.createElement('div');
                controlItem.className = 'control-item';
                controlItem.dataset.index = index;
                
                // Create color picker input
                const colorPicker = document.createElement('input');
                colorPicker.type = 'color';
                colorPicker.value = category.color;
                colorPicker.className = 'color-picker';
                colorPicker.addEventListener('change', function() {
                    // Update category color and refresh the chart
                    categories[index].color = this.value;
                    updateChart();
                    saveToLocalStorage();
                });
                
                // Create category name input
                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.value = category.name;
                nameInput.placeholder = 'Category name';
                nameInput.addEventListener('input', function() {
                    // Update category name and refresh the chart
                    categories[index].name = this.value;
                    updateChart();
                    saveToLocalStorage();
                });
                
                // Create hours input
                const hoursInput = document.createElement('input');
                hoursInput.type = 'number';
                hoursInput.min = '0';
                hoursInput.max = totalHours.toString();
                hoursInput.value = category.value;
                hoursInput.addEventListener('input', function() {
                    // Update category hours and refresh the chart
                    // Convert to integer or default to 0 if NaN
                    categories[index].value = parseInt(this.value) || 0;
                    updateChart();
                    saveToLocalStorage();
                });
                
                // Create remove button
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-btn';
                removeBtn.textContent = 'Ã—';
                removeBtn.title = 'Remove category';
                removeBtn.addEventListener('click', function() {
                    // Remove this category
                    removeCategory(index);
                });
                
                // Assemble all elements into the control item
                controlItem.appendChild(colorPicker);
                controlItem.appendChild(nameInput);
                controlItem.appendChild(hoursInput);
                controlItem.appendChild(removeBtn);
                controlsContainer.appendChild(controlItem);
            });
        }

        /**
         * Adds a new category to the application
         * 
         * Creates a new category with default values, adds it to the categories array,
         * updates the UI, and saves the changes to localStorage.
         */
        function addCategory() {
            // Choose a color from the palette, cycling through available colors
            const colorIndex = categories.length % colorPalette.length;
            
            // Create and add the new category
            categories.push({
                name: `Activity ${categories.length + 1}`,
                value: 0,
                color: colorPalette[colorIndex]
            });
            
            // Update UI
            renderControls();
            updateChart();
            saveToLocalStorage();
        }
        
        /**
         * Removes a category from the application
         * 
         * @param {number} index - The index of the category to remove
         */
        function removeCategory(index) {
            // Ensure we always keep at least one category
            if (categories.length > 1) {
                // Remove the category at the specified index
                categories.splice(index, 1);
                
                // Update UI
                renderControls();
                updateChart();
                saveToLocalStorage();
            } else {
                alert("You must have at least one category.");
            }
        }

        //====================================================================
        // EXPORT FUNCTIONALITY
        //====================================================================
        
        /**
         * Exports the chart as an image file (PNG or JPEG)
         * 
         * @param {string} type - The image type: 'png' or 'jpeg'
         */
        function exportAsImage(type) {
            // Create a temporary link element for the download
            const link = document.createElement('a');
            link.download = `ATLAS-chart.${type}`;
            
            // Get the canvas as a data URL with the specified image type
            const dataUrl = document.getElementById('activityChart').toDataURL(`image/${type}`, 1.0);
            link.href = dataUrl;
            
            // Trigger the download by programmatically clicking the link
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        /**
         * Exports the categories data as a CSV file
         * 
         * Creates a CSV file with columns for category name, hours, and color,
         * then triggers a download of this file.
         */
        function exportAsCSV() {
            // Create CSV content with header row
            let csvContent = "Category,Hours,Color\n";
            
            // Add a row for each category
            categories.forEach(category => {
                // Use quotes around text fields to handle commas in names
                csvContent += `"${category.name}",${category.value},"${category.color}"\n`;
            });
            
            // Create a temporary link element for the download
            const link = document.createElement('a');
            link.download = "ATLAS-data.csv";
            
            // Create a Blob from the CSV content
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            link.href = URL.createObjectURL(blob);
            
            // Trigger the download by programmatically clicking the link
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Clean up by revoking the object URL
            URL.revokeObjectURL(link.href);
        }
        
        /**
         * Exports the categories data as a JSON file
         * 
         * Creates a formatted JSON file containing the categories array,
         * then triggers a download of this file.
         */
        function exportAsJSON() {
            // Create a formatted JSON string from the categories data
            const jsonContent = JSON.stringify(categories, null, 2);
            
            // Create a temporary link element for the download
            const link = document.createElement('a');
            link.download = "ATLAS-data.json";
            
            // Create a Blob from the JSON content
            const blob = new Blob([jsonContent], { type: 'application/json' });
            link.href = URL.createObjectURL(blob);
            
            // Trigger the download by programmatically clicking the link
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Clean up by revoking the object URL
            URL.revokeObjectURL(link.href);
        }

        //====================================================================
        // EVENT LISTENERS
        //====================================================================
        
        /**
         * Set up all application event listeners
         * 
         * Attaches event handlers to buttons and input elements for user interactions
         */
        
        // Add a new category when the "Add Category" button is clicked
        addCategoryBtn.addEventListener('click', addCategory);
        
        // Reset to defaults when the clear storage button is clicked (with confirmation)
        clearStorageBtn.addEventListener('click', function() {
            if (confirm("Are you sure you want to reset to default settings? This will remove any custom categories and restore the original values.")) {
                clearLocalStorage();
            }
        });
        
        // Export buttons event handlers
        exportPngBtn.addEventListener('click', () => exportAsImage('png'));
        exportJpegBtn.addEventListener('click', () => exportAsImage('jpeg'));
        exportCsvBtn.addEventListener('click', exportAsCSV);
        exportJsonBtn.addEventListener('click', exportAsJSON);
        
        // Update totalHours when the input changes
        totalHoursInput.addEventListener('change', function() {
            totalHours = parseInt(this.value) || 40;
            updateChartTitle();
            updateChart();
            saveToLocalStorage();
        });
        
        // Update total hours when start time changes
        startTimeInput.addEventListener('change', function() {
            updateTotalFromTimes();
        });
        
        // Update total hours when end time changes
        endTimeInput.addEventListener('change', function() {
            updateTotalFromTimes();
        });
        
        /**
         * Converts 12-hour time format to 24-hour format
         * 
         * @param {number} hour - Hour in 12-hour format (1-12)
         * @param {string} amPm - "am" or "pm" indicator
         * @returns {number} Hour in 24-hour format (0-23)
         */
        function convertTo24Hour(hour, amPm) {
            // Handle 12 AM/PM special cases first
            if (hour === 12) {
                return amPm === "am" ? 0 : 12;
            }
            
            // Convert normal hours
            return amPm === "am" ? hour : hour + 12;
        }
        
        /**
         * Converts 24-hour time format to 12-hour format
         * 
         * @param {number} hour24 - Hour in 24-hour format (0-23)
         * @returns {number} Hour in 12-hour format (1-12)
         */
        function convertTo12Hour(hour24) {
            if (hour24 === 0) return 12;  // 12 AM
            if (hour24 === 12) return 12; // 12 PM
            if (hour24 > 12) return hour24 - 12; // PM hours
            return hour24; // AM hours
        }
        
        /**
         * Calculates total weekly hours based on daily start and end times
         * 
         * @param {number} startHour - Work day start hour (12-hour format, always AM)
         * @param {number} endHour - Work day end hour (12-hour format, always PM)
         * @returns {number} Total weekly hours (5 work days)
         */
        function calculateTotalHours(startHour, endHour) {
            // Convert to 24-hour format for easier calculation
            // Start is always AM, End is always PM
            const start24 = convertTo24Hour(startHour, "am");
            const end24 = convertTo24Hour(endHour, "pm");
            
            // Calculate daily hours
            let dailyHours = end24 - start24;
            
            // Ensure we don't get negative hours (shouldn't happen with our AM/PM constraints)
            if (dailyHours < 0) {
                console.warn("Invalid time calculation detected. Defaulting to 8 hours.");
                dailyHours = 8; // Default to standard work day
            }
            
            // Calculate weekly hours (5 work days)
            return dailyHours * 5;
        }
        
        /**
         * Updates the total hours based on start and end time selections
         * 
         * Recalculates the total available hours when either the start or end time
         * changes, and updates the UI and saves the new configuration.
         */
        function updateTotalFromTimes() {
            // Get selected time values
            const startHour = parseInt(startTimeInput.value) || 9; // Default to 9 if invalid
            const endHour = parseInt(endTimeInput.value) || 5;     // Default to 5 if invalid
            
            // Ensure hours are within valid range (1-12)
            const validStartHour = Math.min(Math.max(startHour, 1), 12);
            const validEndHour = Math.min(Math.max(endHour, 1), 12);
            
            // Update input values if they were corrected
            if (validStartHour !== startHour) {
                startTimeInput.value = validStartHour;
            }
            if (validEndHour !== endHour) {
                endTimeInput.value = validEndHour;
            }
            
            // Calculate new total hours (start is AM, end is PM)
            const newTotalHours = calculateTotalHours(validStartHour, validEndHour);
            
            // Update the total hours input
            totalHoursInput.value = newTotalHours;
            totalHours = newTotalHours;
            
            // Update the rest of the UI
            updateChartTitle();
            updateChart();
            saveToLocalStorage();
        }

        //====================================================================
        // CONTACT MODAL FUNCTIONALITY
        //====================================================================
        
        /**
         * Contact modal functionality
         * 
         * Handles opening and closing the contact information modal
         */
        const modal = document.getElementById("contactModal");
        const contactBtn = document.getElementById("contactBtn");
        const closeBtn = document.getElementsByClassName("close")[0];
        
        // Open the modal when the contact button is clicked
        contactBtn.addEventListener('click', function() {
            modal.style.display = "block";
        });
        
        // Close the modal when the Ã— button is clicked
        closeBtn.addEventListener('click', function() {
            modal.style.display = "none";
        });
        
        // Close the modal when clicking outside of it
        window.addEventListener('click', function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        });

        //====================================================================
        // APPLICATION INITIALIZATION
        //====================================================================
        
        /**
         * Initializes the application
         * 
         * This function is called when the page loads and sets up the application
         * by loading saved data, rendering the UI, and creating the chart.
         */
        function initApp() {
            // Load data from localStorage or use defaults
            loadFromLocalStorage();
            
            // Initialize UI controls
            renderControls();
            
            // Ensure Chart.js is fully loaded before creating chart
            // Using a small delay to ensure the DOM is ready
            setTimeout(function() {
                try {
                    chart = createChart();
                    updateChart();
                } catch (e) {
                    console.error("Error creating chart:", e);
                    // Try again after a short delay if initial attempt fails
                    setTimeout(function() {
                        chart = createChart();
                        updateChart();
                    }, 500);
                }
            }, 100);
            
            // Check if we have saved data to show appropriate notification
            const hasSavedData = localStorage.getItem(STORAGE_KEY_CATEGORIES) !== null;
            if (hasSavedData) {
                // Show notification that data was loaded
                storageNotice.textContent = 'Your saved data has been loaded from browser storage.';
                showStorageNotice();
            }
        }

        // Initialize the app when the page loads
        window.addEventListener('load', initApp);
    </script>
</body>
</html>